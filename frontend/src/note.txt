const WorkoutModal = ({ 
  showModal, 
  setShowModal, 
  modalType,
  selectedWorkoutId,
  setSelectedWorkoutId 
}) => {
  // State untuk form input strength dengan exercises
  const [strengthForm, setStrengthForm] = useState({
    name: '',
    date: new Date().toISOString().split('T')[0],
    duration: '',
    rpe: '',
    notes: '',
    exercises: [
      {
        name: '',
        sets: [
          {
            weight: '',
            reps: ''
          }
        ]
      }
    ]
  });

  // State untuk cardio form
  const [cardioForm, setCardioForm] = useState({
    activityType: 'Running',
    date: new Date().toISOString().split('T')[0],
    distance: '',
    duration: '',
    location: '',
    notes: ''
  });

  // State untuk loading dan error
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Calculate total volume whenever exercises change
  const calculateTotalVolume = () => {
    return strengthForm.exercises.reduce((total, exercise) => {
      const exerciseVolume = exercise.sets.reduce((exerciseTotal, set) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseFloat(set.reps) || 0;
        return exerciseTotal + (weight * reps);
      }, 0);
      return total + exerciseVolume;
    }, 0);
  };

  const totalVolume = calculateTotalVolume();

  // Reset form ketika modal ditutup/dibuka
  const handleClose = () => {
    setShowModal(false);
    setError('');
    setStrengthForm({
      name: '',
      date: new Date().toISOString().split('T')[0],
      duration: '',
      rpe: '',
      notes: '',
      exercises: [
        {
          name: '',
          sets: [
            {
              weight: '',
              reps: ''
            }
          ]
        }
      ]
    });
    setCardioForm({
      activityType: 'Running',
      date: new Date().toISOString().split('T')[0],
      distance: '',
      duration: '',
      location: '',
      notes: ''
    });
  };

  if (!showModal) return null;

  // Handle input change untuk strength form utama
  const handleStrengthChange = (e) => {
    setStrengthForm({ 
      ...strengthForm, 
      [e.target.name]: e.target.value 
    });
  };

  // Handle input change untuk cardio
  const handleCardioChange = (e) => {
    setCardioForm({ 
      ...cardioForm, 
      [e.target.name]: e.target.value 
    });
  };

  // Handle exercise name change
  const handleExerciseNameChange = (exerciseIndex, value) => {
    const updatedExercises = [...strengthForm.exercises];
    updatedExercises[exerciseIndex].name = value;
    setStrengthForm({
      ...strengthForm,
      exercises: updatedExercises
    });
  };

  // Handle set change
  const handleSetChange = (exerciseIndex, setIndex, field, value) => {
    const updatedExercises = [...strengthForm.exercises];
    updatedExercises[exerciseIndex].sets[setIndex][field] = value;
    setStrengthForm({
      ...strengthForm,
      exercises: updatedExercises
    });
  };

  // Add new exercise
  const addExercise = () => {
    setStrengthForm({
      ...strengthForm,
      exercises: [
        ...strengthForm.exercises,
        {
          name: '',
          sets: [
            {
              weight: '',
              reps: ''
            }
          ]
        }
      ]
    });
  };

  // Remove exercise
  const removeExercise = (exerciseIndex) => {
    if (strengthForm.exercises.length > 1) {
      const updatedExercises = strengthForm.exercises.filter((_, index) => index !== exerciseIndex);
      setStrengthForm({
        ...strengthForm,
        exercises: updatedExercises
      });
    }
  };

  // Add set to exercise
  const addSet = (exerciseIndex) => {
    const updatedExercises = [...strengthForm.exercises];
    updatedExercises[exerciseIndex].sets.push({
      weight: '',
      reps: ''
    });
    setStrengthForm({
      ...strengthForm,
      exercises: updatedExercises
    });
  };

  // Remove set from exercise
  const removeSet = (exerciseIndex, setIndex) => {
    const updatedExercises = [...strengthForm.exercises];
    if (updatedExercises[exerciseIndex].sets.length > 1) {
      updatedExercises[exerciseIndex].sets = updatedExercises[exerciseIndex].sets.filter((_, index) => index !== setIndex);
      setStrengthForm({
        ...strengthForm,
        exercises: updatedExercises
      });
    }
  };

  // Validasi form
  const validateForm = () => {
    if (modalType === 'strength') {
      if (!strengthForm.name.trim()) {
        setError('Workout name is required');
        return false;
      }
      if (!strengthForm.duration || strengthForm.duration <= 0) {
        setError('Duration must be greater than 0');
        return false;
      }
      
      // Validasi exercises
      for (let i = 0; i < strengthForm.exercises.length; i++) {
        const exercise = strengthForm.exercises[i];
        if (!exercise.name.trim()) {
          setError(`Exercise ${i + 1} name is required`);
          return false;
        }
        
        for (let j = 0; j < exercise.sets.length; j++) {
          const set = exercise.sets[j];
          if (!set.weight || set.weight <= 0) {
            setError(`Set ${j + 1} in "${exercise.name}" must have weight greater than 0`);
            return false;
          }
          if (!set.reps || set.reps <= 0) {
            setError(`Set ${j + 1} in "${exercise.name}" must have reps greater than 0`);
            return false;
          }
        }
      }
    } else {
      if (!cardioForm.distance || cardioForm.distance <= 0) {
        setError('Distance must be greater than 0');
        return false;
      }
      if (!cardioForm.duration || cardioForm.duration <= 0) {
        setError('Duration must be greater than 0');
        return false;
      }
    }
    return true;
  };

  // Handle save workout
  const handleSave = async () => {
    if (!validateForm()) return;

    setLoading(true);
    setError('');

    try {
      const token = localStorage.getItem('token');
      
      if (!token) {
        throw new Error('No authentication token found');
      }

      let endpoint = '';
      let body = {};

      if (modalType === 'strength') {
        // Format exercises data dengan tipe number yang benar
        const formattedExercises = strengthForm.exercises.map(exercise => ({
          name: exercise.name,
          sets: exercise.sets.map(set => ({
            weight: parseFloat(set.weight),
            reps: parseInt(set.reps)
          }))
        }));

        endpoint = '/api/strength';
        body = {
          name: strengthForm.name,
          date: strengthForm.date,
          duration: parseInt(strengthForm.duration),
          rpe: strengthForm.rpe ? parseInt(strengthForm.rpe) : null,
          notes: strengthForm.notes,
          exercises: formattedExercises,
          totalVolume: totalVolume // Kirim total volume yang sudah dihitung
        };
      } else {
        endpoint = '/api/cardio';
        body = {
          activityType: cardioForm.activityType,
          date: cardioForm.date,
          distance: parseFloat(cardioForm.distance),
          duration: parseInt(cardioForm.duration),
          location: cardioForm.location,
          notes: cardioForm.notes
        };
      }

      console.log('Sending data:', body); // Debug log

      const response = await fetch(`http://localhost:5000${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();

      if (!response.ok) {
        // Jika ada error validasi dari backend
        if (data.errors && data.errors.length > 0) {
          const errorMessages = data.errors.map(error => error.msg).join(', ');
          throw new Error(errorMessages);
        }
        throw new Error(data.error || data.message || `Failed to save ${modalType} workout`);
      }

      // Success
      console.log(`${modalType} workout saved:`, data);
      alert(`${modalType.charAt(0).toUpperCase() + modalType.slice(1)} workout saved successfully!`);
      
      handleClose();
      
      // Refresh the page to show new data setelah delay kecil
      setTimeout(() => {
        window.location.reload();
      }, 1000);
      
    } catch (err) {
      console.error('Save workout error:', err);
      setError(err.message || `Failed to save ${modalType} workout`);
    } finally {
      setLoading(false);
    }
  };